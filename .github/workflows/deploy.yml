name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [master]

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli@3

      - name: Deploy to Railway
        run: railway up --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}

      - name: Post-deploy health check
        run: |
          echo "Waiting 30s for deployment to stabilize..."
          sleep 30
          HEALTH_URL="${{ vars.DEPLOY_URL || 'https://raid-ai-app-production.up.railway.app' }}/health"
          echo "Checking health at $HEALTH_URL"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "Health check passed (attempt $i)"
              exit 0
            fi
            echo "Attempt $i: status=$STATUS, retrying in 15s..."
            sleep 15
          done
          echo "Health check failed after 5 attempts"
          exit 1
